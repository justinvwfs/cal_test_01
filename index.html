<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BSDå°ˆå±¬ç²¾ç®—æ ¸å¿ƒ - è‘µèŠ±å¯¶å…¸åŠ å¼·ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        :root { --vw-blue: #001e50; --vw-light-blue: #00b0f0; --glass: rgba(255, 255, 255, 0.95); --text: #1e293b; --danger: #e11d48; --success: #10b981; --warning: #f59e0b; --agent-color: #0284c7; }
        
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f1f5f9; margin: 0; padding: 10px; color: var(--text); -webkit-text-size-adjust: 100%; }
        
        .main-container { max-width: 1400px; margin: auto; position: relative; }
        .view-section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Titles */
        .glass-card { background: var(--glass); border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,30,80,0.08); border-top: 4px solid var(--vw-blue); margin-bottom: 20px; position: relative; }
        .section-title { font-size: 1.3rem; font-weight: 900; color: var(--vw-blue); margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .author-tag { font-size: 11px; color: var(--vw-light-blue); font-weight: bold; margin-left: 5px; }

        /* Inputs */
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 11px; font-weight: bold; color: #64748b; margin-bottom: 4px; }
        .input-group input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 14px; font-weight: bold; color: var(--vw-blue); box-sizing: border-box; transition: 0.2s; }
        .input-group input:focus { border-color: var(--vw-light-blue); outline: none; box-shadow: 0 0 0 3px rgba(0,176,240,0.1); }
        .req { color: var(--danger); margin-left: 3px; }

        /* Buttons */
        .btn { cursor: pointer; border: none; font-weight: bold; border-radius: 6px; touch-action: manipulation; transition: 0.2s; white-space: nowrap; }
        .btn:active { transform: scale(0.98); }
        .btn-calc { width: 100%; background: var(--vw-blue); color: white; padding: 14px; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-factory-entry { background: linear-gradient(135deg, #00b0f0 0%, #0077cc 100%); color: white; padding: 8px 16px; font-size: 13px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0, 176, 240, 0.3); display: flex; align-items: center; gap: 5px; }
        .btn-back { background: #64748b; color: white; padding: 8px 16px; font-size: 13px; border-radius: 20px; }
        .btn-super-gen { width: 100%; background: linear-gradient(135deg, #001e50 0%, #004e92 100%); color: white; padding: 16px; font-size: 18px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 78, 146, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .btn-reset { width: 100%; background: #f1f5f9; color: #64748b; padding: 10px; margin-top: 10px; }
        
        /* Excel Button Styling */
        .btn-excel { background: #107c41; color: white; padding: 8px 15px; font-size: 13px; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(16, 124, 65, 0.2); }
        .btn-excel:hover { background: #0c5e31; }

        .btn-rev { background: var(--warning); color: #fff; font-size: 11px; padding: 3px 8px; border-radius: 4px; margin-top: 4px; }
        .btn-del { background: var(--danger); color: white; font-size: 11px; padding: 4px 10px; border-radius: 4px; }
        .btn-gen-row { background: var(--success); color: white; padding: 12px; font-size: 15px; width: 100%; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2); }
        .btn-export { background: var(--vw-light-blue); color: white; padding: 8px 15px; font-size: 13px; }

        .check-wrap { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
        .check-wrap input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .check-label { font-size: 11px; font-weight: bold; color: var(--danger); }

        /* Single Mode Layout */
        .single-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .res-box { background: #f0f9ff; border: 2px dashed var(--vw-light-blue); padding: 10px; border-radius: 8px; margin: 15px 0; text-align: center; }
        .res-val { font-size: 1.5rem; font-weight: 900; }
        .phase-header, .phase-grid { display: grid; grid-template-columns: 60px 1fr 65px; gap: 8px; margin-bottom: 5px; }
        .dashboard { background: linear-gradient(135deg, var(--vw-blue) 0%, #003380 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .dash-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .dash-item { border-left: 3px solid var(--vw-light-blue); padding-left: 10px; }
        .dash-val { font-size: 1.3rem; font-weight: bold; margin-top: 2px; }
        .payment-summary { font-size: 13px; line-height: 1.5; background: rgba(255,255,255,0.08); padding: 10px; border-radius: 6px; }

        /* Factory Layout */
        .factory-config { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .factory-range { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; align-items: end; }
        .term-selector { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .term-check { display: flex; align-items: center; gap: 4px; background: white; padding: 6px 12px; border-radius: 20px; border: 1px solid #cbd5e1; font-size: 13px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .term-check:hover { background: #f1f5f9; }

        /* Tables */
        .sf-table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #cbd5e1; max-height: 600px; margin-bottom: 20px; background: white; }
        .sf-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: center; white-space: nowrap; }
        .sf-table th, .sf-table td { padding: 12px 8px; border: 1px solid #e2e8f0; vertical-align: middle; }
        .sf-table th { background: var(--vw-blue); color: white; position: sticky; top: 0; z-index: 10; font-weight: bold; }
        .sf-table th.row-header { position: sticky; left: 0; z-index: 11; background: var(--vw-blue); border-right: 2px solid #334155; }
        .sf-table td.row-header { position: sticky; left: 0; z-index: 9; background: #f8fafc; font-weight: 900; border-right: 2px solid #cbd5e1; color: var(--vw-blue); }
        .sf-table tr:nth-child(even) { background: #f8fafc; }

        /* Amort Table Customization */
        #amortTable td { color: #334155; font-weight: bold; }
        #amortTable td:nth-child(2) { color: var(--vw-blue); font-weight: 900; font-size: 14px; }
        #amortTable td:nth-child(5) { color: #94a3b8; font-weight: normal; }

        .res-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; }
        .res-pmt { font-weight: 900; font-size: 15px; color: var(--text); }
        .res-rate { font-size: 11px; color: var(--vw-light-blue); font-weight: bold; }
        .res-sub { font-size: 10px; font-weight: bold; line-height: 1.3; text-align: center; display: flex; flex-direction: column; }

        /* Manual Input Area */
        .manual-input-area { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #cbd5e1; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .manual-top-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .phases-wrapper { background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        .phases-label { font-size: 11px; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        .phases-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .phase-box { display: flex; flex-direction: column; min-width: 70px; background: white; padding: 5px; border-radius: 6px; border: 1px solid #e2e8f0; }
        .phase-box label { font-size: 10px; color: #64748b; font-weight: bold; text-align: center; margin-bottom: 3px; }
        .phase-box input { padding: 6px; text-align: center; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 4px; }
        
        .result-list-table th { background: #334155; color: white; padding: 12px; }
        .result-list-table td:first-child { font-size: 16px; font-weight: 900; color: var(--vw-blue); min-width: 120px; text-align: left; padding-left: 15px; } 
        .result-list-table td { font-size: 13px; padding: 12px; vertical-align: middle; }
        .detail-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .detail-item { background: #f1f5f9; padding: 4px 10px; border-radius: 4px; font-weight: bold; color: #334155; font-size: 12px; white-space: nowrap; border: 1px solid #e2e8f0; }

        /* --- çœ¼ç›è¶…èˆ’æœæ¨¡å¼ CSS Start --- */
        .comfort-trigger-btn {
            background-color: #2ecc71; color: white; border: none; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; cursor: pointer; font-weight: bold;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.4); 
            display: block; /* ç¨ç«‹å€å¡Š */
            margin-top: 10px; margin-bottom: 10px; width: 100%;
            text-align: center; position: relative; z-index: 100;
        }

        .comfort-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f2f5; z-index: 9999;
            display: flex; flex-direction: column;
            padding-top: 20px; 
            box-sizing: border-box; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
        }

        /* å°ˆæ¥­æµç¨‹é€²åº¦æ¢ */
        .comfort-stepper {
            height: 14vh; background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            display: flex; align-items: center; justify-content: flex-start;
            padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            overflow-x: auto; gap: 15px; flex-shrink: 0; 
        }

        .step-item {
            display: flex; flex-direction: column; align-items: center;
            position: relative; min-width: 60px; z-index: 1; opacity: 0.5; transition: 0.3s;
        }
        .step-circle {
            width: 28px; height: 28px; border-radius: 50%;
            background: #e0e0e0; color: #555;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; transition: 0.3s;
            border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc;
        }
        .step-label {
            margin-top: 6px; font-size: 11px; color: #999; font-weight: bold;
            white-space: nowrap;
        }
        /* é€²åº¦æ¢ä¸‹æ–¹çš„æ•¸æ“šé¡¯ç¤º */
        .step-data {
            font-size: 10px; color: #2ecc71; font-weight: 900;
            margin-top: 2px; height: 14px; opacity: 0; transition: opacity 0.5s ease-in-out;
            white-space: nowrap;
        }
        
        .step-line {
            width: 20px; height: 2px; background: #e0e0e0; margin-top: -20px; flex-shrink: 0;
        }

        .step-item.active { opacity: 1; transform: scale(1.05); }
        .step-item.active .step-circle { background: #2ecc71; color: white; box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3); border-color: #2ecc71; }
        .step-item.active .step-label { color: #2ecc71; }
        
        .step-item.done { opacity: 1; }
        .step-item.done .step-circle { background: #27ae60; color: white; border-color: #27ae60; box-shadow: none; }
        .step-item.done .step-label { color: #27ae60; }
        .step-item.done .step-data { opacity: 1; }
        .step-line.done { background: #27ae60; }

        /* PC Layout Default (Flex Start for visibility) */
        .comfort-container {
            flex: 1; 
            display: flex; 
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 40px 20px 20px 20px;
            overflow-y: auto;
        }

        .comfort-question-area {
            width: 100%; max-width: 600px; text-align: center;
        }

        .c-title { font-size: 1.8rem; font-weight: bold; color: #333; margin-bottom: 20px; }
        .c-subtitle { font-size: 1rem; color: #666; margin-bottom: 10px; }
        .c-input {
            width: 80%; padding: 15px; font-size: 2rem; text-align: center;
            border: 2px solid #2ecc71; border-radius: 10px; outline: none;
            margin-bottom: 20px; background: #fff;
        }
        .c-input:focus { box-shadow: 0 0 15px rgba(46, 204, 113, 0.3); }

        .c-btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .c-btn-option {
            padding: 20px 30px; font-size: 1.2rem; border: 2px solid #ddd;
            border-radius: 10px; background: white; cursor: pointer; flex: 1;
        }
        .c-btn-option.selected { background: #2ecc71; color: white; border-color: #2ecc71; }

        .c-btn-submit {
            background: #2ecc71; color: white; padding: 15px 40px;
            font-size: 1.5rem; border: none; border-radius: 50px; cursor: pointer;
            width: 80%; max-width: 300px; margin-top: 10px; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
        }
        .c-btn-submit:active { transform: scale(0.98); }

        .comfort-footer {
            height: 10vh; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: #fff; border-top: 1px solid #eee; flex-shrink: 0;
        }
        .c-btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 1rem; cursor: pointer; }
        .c-btn-secondary { background: #eee; color: #555; }
        .c-btn-restart { 
            background: transparent; border: 2px solid #2ecc71; color: #2ecc71; 
            padding: 10px 20px; border-radius: 50px; font-weight: bold;
            transition: 0.2s; cursor: pointer;
        }
        .c-btn-restart:hover { background: #e8f8f5; }

        .c-btn-danger { background: #fff0f0; color: #e74c3c; }

        .comfort-error-msg { color: #e74c3c; font-size: 1.2rem; margin-top: 10px; height: 20px; font-weight: bold;}

        /* Professional Dashboard in Comfort Mode */
        .dash-card-pro {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            border-radius: 20px; padding: 25px; color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; text-align: left;
            position: relative; overflow: hidden;
        }
        .dash-card-pro::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px; background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .pro-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; }
        .pro-title { font-size: 1.2rem; font-weight: bold; color: #4ade80; }
        .pro-tag { background: rgba(255,255,255,0.2); font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; }
        
        /* Toggle Switch Style */
        .toggle-container { margin-top: 15px; display: flex; justify-content: flex-end; width: 100%; }
        .toggle-switch { display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #2c3e50; font-weight: bold; }
        .toggle-switch input { display: none; }
        .slider { width: 34px; height: 18px; background-color: #cbd5e1; border-radius: 20px; position: relative; margin-right: 8px; transition: .3s; }
        .slider:before { content: ""; position: absolute; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: .3s; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(16px); }

        .pro-hero { text-align: center; margin-bottom: 25px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; }
        .pro-hero-label { font-size: 0.9rem; color: #a5b4fc; margin-bottom: 8px; }
        .pro-hero-val { font-size: 1.8rem; font-weight: 900; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.3); line-height: 1.4; white-space: pre-line; }
        
        .pro-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .pro-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
        .pro-item.wide { grid-column: span 2; background: rgba(255,255,255,0.1); border-left: 3px solid #2ecc71; }
        .pro-label { font-size: 0.8rem; color: #9ca3af; }
        .pro-val { font-size: 1.1rem; font-weight: bold; color: #fff; margin-top: 2px; }
        
        .pro-footer { margin-top: 20px; font-size: 0.8rem; color: #6b7280; text-align: center; }

        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        /* --- çœ¼ç›è¶…èˆ’æœæ¨¡å¼ CSS End --- */

        /* â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆå°ˆå±¬å„ªåŒ– (Screenshot Friendly) â˜…â˜…â˜… */
        @media (max-width: 768px) {
            .single-grid { grid-template-columns: 1fr; }
            .factory-range { grid-template-columns: 1fr 1fr; }
            .factory-range .btn-super-gen { grid-column: span 2; }
            .manual-top-grid { grid-template-columns: 1fr; gap: 10px; }
            .section-title { font-size: 1.1rem; }
            .sf-table th, .sf-table td { padding: 8px 4px; }

            /* æ‰‹æ©Ÿç‰ˆå„€è¡¨æ¿ç·Šæ¹ŠåŒ– */
            .comfort-container {
                padding: 10px 10px 20px 10px; /* æ¸›å°‘ä¸Šæ–¹ç•™ç™½ï¼Œè®“å„€è¡¨æ¿ç›¡é‡æ»¿ç‰ˆ */
                justify-content: flex-start; 
            }
            .dash-card-pro {
                padding: 15px; /* æ¸›å°‘å¡ç‰‡å…§è· */
                border-radius: 15px;
            }
            .pro-hero { margin-bottom: 15px; padding: 10px; }
            .pro-hero-val { font-size: 1.5rem; } /* å­—é«”å¾®èª¿ï¼Œé¿å…æ›è¡Œ */
            .pro-grid { gap: 8px; } /* ç¶²æ ¼æ›´ç·Šå¯† */
            .pro-item { padding: 8px; }
            .pro-val { font-size: 1rem; }
            
            /* æŒ‰éˆ•å€åŸŸç·Šæ¹Š */
            .c-btn-submit, .c-btn-restart {
                margin-top: 10px;
                padding: 10px;
            }
        }

        /* NATIVE PRINT STYLES */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { 
                background: white; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                padding: 0 !important; 
            }
            
            #comfort-overlay, .comfort-trigger-btn, .btn, .sidebar button { display: none !important; }
            
            .main-container, #view-single, .content, #print-area { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; opacity: 1 !important; visibility: visible !important; }
            
            .sidebar { display: none !important; }
            .single-grid { display: block !important; }
            
            .dashboard { background: linear-gradient(135deg, var(--vw-blue) 0%, #003380 100%) !important; color: white !important; }
            .dash-row { display: grid !important; grid-template-columns: 1fr 1fr 1fr !important; gap: 10px !important; }
            .dash-item { border-left: 3px solid var(--vw-light-blue) !important; color: white !important; }
            .dash-val { color: white !important; }
            .glass-card { border: none !important; box-shadow: none !important; padding: 0 !important; page-break-inside: avoid; }
            .table-container { overflow: visible !important; }
            table { width: 100% !important; font-size: 11px !important; }
            th, td { padding: 6px !important; border: 1px solid #ccc !important; }
        }
    </style>
</head>
<body onload="initAll()">

<div class="main-container">
    
    <div id="view-single" class="view-section active">
        <div class="single-grid">
            <div class="sidebar">
                <div class="glass-card">
                    <div class="section-title">
                        <div>BSDå°ˆå±¬ç²¾ç®—æ ¸å¿ƒ <span class="author-tag">ä»Šæ™šæ²’å–å¤ çš„å°è³ˆå“¥</span></div>
                        <button class="btn btn-factory-entry" onclick="switchView('factory')">
                            <span>âœ¨</span> è‘µèŠ±å¯¶å…¸å·¥å» 
                        </button>
                    </div>
                    
                    <button class="comfort-trigger-btn" onclick="ComfortMode.init()">
                        ğŸ‘ï¸ çœ¼ç›è¶…èˆ’æœæ¨¡å¼ (å•Ÿå‹•)
                    </button>
                    
                    <div style="margin-top:15px;"></div>

                    <div class="input-group"><label>å»ºè­°å”®åƒ¹ </label><input type="number" id="MSRP" placeholder="å¯è¼¸å…¥è»Šè¼›åŸå§‹å”®åƒ¹" oninput="updateUI()"></div>
                    <div class="input-group"><label>åˆ†æœŸæœ¬é‡‘ <span class="req">*</span></label><input type="number" id="B20" placeholder="è«‹è¼¸å…¥åˆ†æœŸæœ¬é‡‘" oninput="updateUI()"></div>
                    <div class="input-group"><label>ç‰Œåƒ¹åˆ©ç‡ % <span class="req">*</span></label><input type="number" id="B4" step="0.01" placeholder="è«‹è¼¸å…¥ç‰Œåƒ¹åˆ©ç‡" oninput="syncRate()"></div>
                    
                    <div class="input-group">
                        <div class="check-wrap"><label style="margin:0;">å®¢æˆ¶åˆ©ç‡ %</label><input type="checkbox" id="rateLock" onchange="updateUI()"><span class="check-label">é–å®š</span></div>
                        <input type="number" id="CRate" step="0.0001" placeholder="å‹¾é¸å¾Œä»¥æ­¤æ¨ç®—æœˆä»˜æ¬¾" oninput="updateUI()">
                    </div>
                    
                    <div class="res-box">
                        <div id="res-title" style="font-size: 11px; font-weight: bold;">è£œè²¼/é€€ä½£çµæœé ä¼°</div>
                        <div class="res-val" id="res-val">$ 0</div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div class="input-group">
                            <div class="check-wrap"><label style="margin:0;">ç¸½ä»£ç†è£œè²¼</label><input type="checkbox" id="agentLock" onchange="updateUI()"><span class="check-label">é–å®š</span></div>
                            <input type="number" id="SubAgent" value="0" placeholder="çµ¦å®šé‡‘é¡" oninput="updateUI()">
                        </div>
                        <div class="input-group">
                            <div class="check-wrap"><label style="margin:0;">ç¶“éŠ·å•†è£œè²¼</label><input type="checkbox" id="dealerLock" onchange="updateUI()"><span class="check-label">é–å®š</span></div>
                            <input type="number" id="SubDealer" value="0" placeholder="çµ¦å®šé‡‘é¡" oninput="updateUI()">
                        </div>
                    </div>

                    <div class="phase-header"><span>æœŸæ•¸<span class="req">*</span></span><span>æœˆä»˜æ¬¾é‡‘é¡</span><span style="text-align:right">MSRP%</span></div>
                    <div id="phases-container">
                        <div class="phase-grid"><input type="number" class="p-m" value="59" placeholder="æœŸ"><input type="number" class="p-v" placeholder="è¼¸å…¥é‡‘é¡" oninput="updateUI()"><span class="pct-label">--%</span></div>
                        <div class="phase-grid"><input type="number" class="p-m" value="1" placeholder="æœŸ"><input type="number" class="p-v" placeholder="è¼¸å…¥é‡‘é¡" oninput="updateUI()"><span class="pct-label">--%</span></div>
                        <div class="phase-grid"><input type="number" class="p-m" placeholder="æœŸ"><input type="number" class="p-v" placeholder="è¼¸å…¥é‡‘é¡" oninput="updateUI()"><span class="pct-label">--%</span></div>
                        <div class="phase-grid"><input type="number" class="p-m" placeholder="æœŸ"><input type="number" class="p-v" placeholder="è¼¸å…¥é‡‘é¡" oninput="updateUI()"><span class="pct-label">--%</span></div>
                        <div class="phase-grid"><input type="number" class="p-m" placeholder="æœŸ"><input type="number" class="p-v" placeholder="è¼¸å…¥é‡‘é¡" oninput="updateUI()"><span class="pct-label">--%</span></div>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn btn-calc" onclick="smartSolve()">åŸ·è¡Œæ™ºæ…§åŒæ­¥è¨ˆç®—</button>
                        <button class="btn btn-reset" onclick="initApp()">æ¸…é™¤æ‰€æœ‰æ¬„ä½</button>
                    </div>
                </div>
            </div>

            <div class="content" id="print-area">
                <div class="dashboard">
                    <div class="dash-row">
                        <div class="dash-item" id="msrp-dash" style="display:none;"><div class="dash-label">å»ºè­°å”®åƒ¹</div><div class="dash-val" id="d-msrp">0</div></div>
                        <div class="dash-item"><div class="dash-label">åˆ†æœŸæœ¬é‡‘</div><div class="dash-val" id="d-pv">0</div></div>
                        <div class="dash-item"><div class="dash-label">å®¢æˆ¶å¯¦éš›åˆ©ç‡ (IRR)</div><div class="dash-val" id="d-crate">-- %</div></div>
                        <div class="dash-item"><div class="dash-label">åˆ†æœŸç¸½æœŸæ•¸</div><div class="dash-val" id="d-terms">0</div></div>
                        <div class="dash-item"><div class="dash-label">ç¸½ä»˜æ¬¾é‡‘é¡</div><div class="dash-val" id="d-total-pmt">0</div></div>
                    </div>
                    <div class="payment-summary" id="d-summary">è«‹è¼¸å…¥åƒæ•¸ä¸¦é»æ“Šè¨ˆç®—...</div>
                    <div class="glass-card" style="margin-top:15px;">
                        <div class="section-title">
                            æœ¬æ¯æ”¤é‚„è¡¨ 
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-excel" onclick="exportSingleExcel()">åŒ¯å‡º EXCEL</button>
                                <button class="btn btn-export" onclick="window.print()">åˆ—å° / å¦å­˜ PDF</button>
                            </div>
                        </div>
                        <div class="table-container"><table id="amortTable" class="sf-table"><thead><tr><th>æœŸæ•¸</th><th>æœˆä»˜æ¬¾</th><th>åˆ©æ¯</th><th>æœ¬é‡‘</th><th>é¤˜é¡</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-factory" class="view-section">
        <div class="glass-card">
            <div class="section-title">
                <div>è‘µèŠ±å¯¶å…¸æ‰¹é‡ç”Ÿç”¢å°å·¥å»  <span class="author-tag">Power by BSD Core</span></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-excel" onclick="exportToExcel()">åŒ¯å‡º EXCEL</button>
                    <button class="btn btn-back" onclick="switchView('single')">è¿”å›ç²¾ç®—æ ¸å¿ƒ</button>
                </div>
            </div>

            <div class="factory-config">
                <div class="input-group">
                    <label>Charge Rate %</label>
                    <input type="number" id="F-ChargeRate" value="5.0" step="0.01" oninput="syncFactoryLock()">
                </div>
                <div class="input-group">
                    <label>Customer Rate %</label>
                    <input type="number" id="F-CustRate" value="5.0" step="0.01" disabled style="background:#e2e8f0;">
                </div>
                <div class="input-group">
                    <label>å®¢æˆ¶åˆ©ç‡å„ªå…ˆé–</label>
                    <div class="check-wrap" style="height:42px; border:1px solid #cbd5e1; border-radius:6px; background:white; padding:0 10px;">
                        <input type="checkbox" id="F-PriorityLock" onchange="syncFactoryLock()">
                        <span style="font-size:12px;">å•Ÿç”¨ (é–å®šåˆ©ç‡)</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>ç¸½ä»£ç†è£œè²¼ (å„ªå…ˆæ‰£é™¤)</label>
                    <input type="number" id="F-SubAgent" value="0">
                </div>
                <div class="input-group">
                    <label id="F-SubDealer-Label">ç¶“éŠ·å•†è£œè²¼</label>
                    <input type="number" id="F-SubDealer" value="0" placeholder="0=è‡ªå‹•æ¶ˆD">
                </div>
            </div>

            <div class="factory-range">
                <div class="input-group"><label>èµ·å§‹ (è¬)</label><input type="number" id="R-Start" value="60"></div>
                <div class="input-group"><label>çµæŸ (è¬)</label><input type="number" id="R-End" value="100"></div>
                <div class="input-group"><label>å€é–“ (è¬)</label><input type="number" id="R-Step" value="5"></div>
                <button class="btn btn-super-gen" onclick="generateMatrix()">ä¸€éµç”Ÿæˆè‘µèŠ±å¯¶å…¸</button>
            </div>
            <div class="term-selector">
                <label class="term-check"><input type="checkbox" value="12">12æœŸ</label>
                <label class="term-check"><input type="checkbox" value="24" checked>24æœŸ</label>
                <label class="term-check"><input type="checkbox" value="36" checked>36æœŸ</label>
                <label class="term-check"><input type="checkbox" value="48" checked>48æœŸ</label>
                <label class="term-check"><input type="checkbox" value="60" checked>60æœŸ</label>
                <label class="term-check"><input type="checkbox" value="72">72æœŸ</label>
            </div>

            <div class="sf-table-container">
                <table class="sf-table" id="sf-matrix">
                    <thead><tr><th class="row-header">åˆ†æœŸé‡‘é¡</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:30px; border-top:4px solid var(--vw-blue); padding-top:20px;">
                <div class="section-title">æ‰‹å‹•æ·»åŠ éšæ®µå¼çµ„åˆ (ç„¡é™ç´¯åŠ )</div>
                <div class="manual-input-area">
                    <div class="manual-top-grid">
                        <div class="input-group">
                            <label>åˆ†æœŸé‡‘é¡ (å®Œæ•´æ•¸å­—)</label>
                            <input type="number" id="M-Amt" placeholder="ä¾‹å¦‚: 1325998" style="background:#f8fafc; border-color:#001e50;">
                        </div>
                        <div class="input-group">
                            <label>Charge %</label>
                            <input type="number" id="M-ChargeRate" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Customer %</label>
                            <input type="number" id="M-CustRate" step="0.01" disabled style="background:#e2e8f0;">
                        </div>
                    </div>

                    <div class="phases-wrapper">
                        <div class="phases-label">æœŸæ•¸èˆ‡é‡‘é¡è¨­å®š (é‡‘é¡ç©ºç™½ = è‡ªå‹•è¨ˆç®—)</div>
                        <div class="phases-scroll">
                            <div class="phase-box"><label>1(æœŸ)</label><input type="number" class="mp-m"><label>é¡</label><input type="number" class="mp-v"></div>
                            <div class="phase-box"><label>2(æœŸ)</label><input type="number" class="mp-m"><label>é¡</label><input type="number" class="mp-v"></div>
                            <div class="phase-box"><label>3(æœŸ)</label><input type="number" class="mp-m"><label>é¡</label><input type="number" class="mp-v"></div>
                            <div class="phase-box"><label>4(æœŸ)</label><input type="number" class="mp-m"><label>é¡</label><input type="number" class="mp-v"></div>
                            <div class="phase-box"><label>5(æœŸ)</label><input type="number" class="mp-m"><label>é¡</label><input type="number" class="mp-v"></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-gen-row" onclick="addManualResultRow()">ç”Ÿæˆä¸¦åŠ å…¥æ¸…å–®</button>
                </div>

                <div class="sf-table-container">
                    <table class="sf-table result-list-table">
                        <thead>
                            <tr>
                                <th>åˆ†æœŸé‡‘é¡</th>
                                <th>ä»˜æ¬¾æ˜ç´°</th>
                                <th style="width:80px;">å®¢æˆ¶åˆ©ç‡</th>
                                <th style="width:160px;">è£œè²¼ç‹€æ³</th>
                                <th style="width:140px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="manual-results-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="comfort-overlay" class="comfort-overlay" style="display: none;">
    <div class="comfort-stepper" id="comfort-stepper">
        </div>

    <div class="comfort-container">
        <div id="comfort-question-area" class="comfort-question-area"></div>
        <div id="comfort-error-msg" class="comfort-error-msg"></div>
    </div>
    <div class="comfort-footer">
        <button class="c-btn c-btn-secondary" onclick="ComfortMode.prevStep()">ä¸Šä¸€æ­¥</button>
        <button class="c-btn c-btn-danger" onclick="ComfortMode.exit()">é›¢é–‹æ¨¡å¼</button>
    </div>
</div>

<script>
    // --- Core Logic (Unchanged) ---
    function calculateActualS(B20, B4_m, flows) {
        let npv_unit = 0; 
        flows.forEach((pmt, i) => { npv_unit += (pmt / B20 * 10000) / Math.pow(1 + B4_m, i + 1); });
        return Math.round(Math.floor(npv_unit - 10000) * B20 / 10000);
    }
    function solveIRR(p0, flows) {
        let r = 0.005; for (let i = 0; i < 64; i++) {
            let f = p0; flows.forEach((pmt, t) => f += pmt / Math.pow(1 + r, t + 1));
            let df = 0; flows.forEach((pmt, t) => df -= ((t + 1) * pmt) / Math.pow(1 + r, t + 2));
            if(Math.abs(df) < 0.0000001) break;
            r = r - f / df;
        } return r;
    }

    // --- Init ---
    function initAll() { initApp(); syncFactoryLock(); }
    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- Tab 1 ---
    function initApp() {
        document.querySelectorAll('#view-single input[type="checkbox"]').forEach(c => c.checked = false);
        document.querySelectorAll('#view-single input:not([type="checkbox"])').forEach(i => i.value = "");
        document.getElementById('SubAgent').value = 0; document.getElementById('SubDealer').value = 0;
        const pms = document.querySelectorAll('.p-m'); pms[0].value = 59; pms[1].value = 1;
        document.getElementById('res-val').innerText = "$ 0";
        updateUI();
    }
    function syncRate() { if (!document.getElementById('rateLock').checked) document.getElementById('CRate').value = document.getElementById('B4').value; updateUI(); }
    function updateUI() {
        const msrp = parseFloat(document.getElementById('MSRP').value) || 0;
        const pv = parseFloat(document.getElementById('B20').value) || 0;
        const rLock = document.getElementById('rateLock').checked;
        const aLock = document.getElementById('agentLock').checked;
        const dLock = document.getElementById('dealerLock').checked;
        document.getElementById('CRate').style.background = rLock ? "#fff1f2" : "#ffffff";
        document.getElementById('SubAgent').style.background = aLock ? "#fff1f2" : "#ffffff";
        document.getElementById('SubDealer').style.background = dLock ? "#fff1f2" : "#ffffff";
        document.getElementById('d-pv').innerText = "$ " + pv.toLocaleString();
        document.getElementById('msrp-dash').style.display = msrp > 0 ? 'block' : 'none';
        document.getElementById('d-msrp').innerText = "$ " + msrp.toLocaleString();
        const pVs = document.querySelectorAll('.p-v'), labels = document.querySelectorAll('.pct-label');
        pVs.forEach((v, i) => {
            const val = parseFloat(v.value) || 0;
            labels[i].innerText = (msrp > 0 && val > 0) ? (val/msrp*100).toFixed(2)+"%" : "--%";
        });
    }
    function smartSolve() {
        const B20 = parseFloat(document.getElementById('B20').value), B4_v = parseFloat(document.getElementById('B4').value);
        if(!B20 || !B4_v) return alert("æœ¬é‡‘è·Ÿç‰Œåƒ¹åˆ©ç‡è¦å¡«å–”ï¼");
        const rLock = document.getElementById('rateLock').checked;
        const aLock = document.getElementById('agentLock').checked;
        const dLock = document.getElementById('dealerLock').checked;
        const pMs = Array.from(document.querySelectorAll('.p-m')).map(i => parseInt(i.value) || 0);
        const pVsInputs = document.querySelectorAll('.p-v');
        const emptyIdx = Array.from(pVsInputs).findIndex((v, i) => pMs[i] > 0 && !v.value);
        if (rLock && aLock && dLock && emptyIdx === -1) return alert("è«‹æ¸…ç©ºä»»æ„æœˆä»˜æ¬¾æ¬„ä½ä»¥é€²è¡Œè¨ˆç®—");
        let target_m = (parseFloat(document.getElementById('CRate').value) || B4_v) / 100 / 12;
        if (emptyIdx !== -1) {
            let knownPV = 0, currentT = 0, factor = 0;
            for (let i = 0; i < pMs.length; i++) {
                for (let j = 0; j < pMs[i]; j++) {
                    currentT++;
                    if (i === emptyIdx) factor += 1 / Math.pow(1 + target_m, currentT);
                    else knownPV += (parseFloat(pVsInputs[i].value) || 0) / Math.pow(1 + target_m, currentT);
                }
            }
            let basePmt = Math.ceil((B20 - knownPV) / factor);
            if (!rLock && (aLock || dLock)) {
                const sA = aLock ? (parseFloat(document.getElementById('SubAgent').value) || 0) : 0;
                const sD = dLock ? (parseFloat(document.getElementById('SubDealer').value) || 0) : 0;
                const targetS_Limit = -(sA + sD); 
                const getS = (p) => {
                    let npv_u = 0, t = 0;
                    for(let i=0; i<pMs.length; i++){
                        for(let j=0; j<pMs[i]; j++){
                            t++;
                            let val = (i === emptyIdx) ? p : (parseFloat(pVsInputs[i].value) || 0);
                            npv_u += (val / B20 * 10000) / Math.pow(1 + (B4_v/100/12), t);
                        }
                    }
                    return Math.round(Math.floor(npv_u - 10000) * B20 / 10000);
                };
                while (getS(basePmt) > targetS_Limit && basePmt > 0) { basePmt--; }
                while (getS(basePmt) < targetS_Limit) { basePmt++; }
                if (getS(basePmt) > targetS_Limit) basePmt--;
            }
            pVsInputs[emptyIdx].value = basePmt;
        }
        renderOutput();
    }
    function renderOutput() {
        const B20 = parseFloat(document.getElementById('B20').value);
        const B4_v = parseFloat(document.getElementById('B4').value);
        const B4_m = (B4_v / 100 / 12);
        const rLock = document.getElementById('rateLock').checked;
        const aLock = document.getElementById('agentLock').checked;
        const dLock = document.getElementById('dealerLock').checked;
        let pMs = Array.from(document.querySelectorAll('.p-m')).map(i => parseInt(i.value) || 0);
        let pVs = Array.from(document.querySelectorAll('.p-v')).map(i => parseFloat(i.value) || 0);
        let flows = []; pMs.forEach((m, i) => { for(let j=0; j<m; j++) flows.push(pVs[i]); });
        let irr_m = solveIRR(-B20, flows);
        const finalCRate = (irr_m * 12 * 100).toFixed(4);
        document.getElementById('d-crate').innerText = finalCRate + "%";
        if(!rLock) document.getElementById('CRate').value = finalCRate;
        let totalS = calculateActualS(B20, B4_m, flows);
        document.getElementById('res-val').innerText = "$ " + Math.abs(totalS).toLocaleString();
        document.getElementById('res-val').style.color = totalS < 0 ? "#dc2626" : "#16a34a";
        let neededTotal = (totalS < 0) ? Math.abs(totalS) : 0;
        let sA = parseFloat(document.getElementById('SubAgent').value) || 0;
        if (dLock) { let actualD = Math.max(0, neededTotal - sA); document.getElementById('SubDealer').value = actualD; }
        else if (aLock) { document.getElementById('SubDealer').value = Math.max(0, neededTotal - sA); }
        else { document.getElementById('SubAgent').value = 0; document.getElementById('SubDealer').value = neededTotal; }
        document.getElementById('d-total-pmt').innerText = "$ " + flows.reduce((a,b)=>a+b, 0).toLocaleString();
        document.getElementById('d-terms').innerText = flows.length + " æœŸ";
        let st = 1, summ = "";
        pMs.forEach((m, i) => { if(m > 0) { summ += `ç¬¬ ${st}-${st+m-1} æœŸï¼š$${pVs[i].toLocaleString()}<br>`; st += m; } });
        document.getElementById('d-summary').innerHTML = summ;
        const tbody = document.querySelector('#amortTable tbody'); tbody.innerHTML = '';
        let bal = B20;
        flows.forEach((pmt, i) => {
            let int = bal * irr_m, princ = pmt - int; bal -= princ;
            tbody.innerHTML += `<tr><td>${i+1}</td><td>${Math.round(pmt).toLocaleString()}</td><td>${Math.round(int).toLocaleString()}</td><td>${Math.round(princ).toLocaleString()}</td><td>${Math.max(0,Math.round(bal)).toLocaleString()}</td></tr>`;
        });
        updateUI();
    }

    // === Excel Export for Tab 1 ===
    function exportSingleExcel() {
        let msrp = document.getElementById('MSRP').value || 0;
        let loan = document.getElementById('B20').value || 0;
        let rate = document.getElementById('d-crate').innerText;
        let term = document.getElementById('d-terms').innerText;
        let total = document.getElementById('d-total-pmt').innerText;
        let data = [
            ["BSD è©¦ç®—å ±å‘Š"], [""],
            ["å»ºè­°å”®åƒ¹", msrp], ["åˆ†æœŸæœ¬é‡‘", loan], ["å®¢æˆ¶åˆ©ç‡", rate], ["ç¸½æœŸæ•¸", term], ["ç¸½ä»˜æ¬¾", total], [""],
            ["æœŸæ•¸", "æœˆä»˜æ¬¾", "åˆ©æ¯", "æœ¬é‡‘", "é¤˜é¡"]
        ];
        let rows = document.querySelectorAll('#amortTable tbody tr');
        rows.forEach(row => {
            let cells = row.querySelectorAll('td');
            let rowData = [];
            cells.forEach(cell => rowData.push(cell.innerText));
            data.push(rowData);
        });
        let ws = XLSX.utils.aoa_to_sheet(data);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "è©¦ç®—å ±å‘Š");
        XLSX.writeFile(wb, "BSD_è©¦ç®—å ±å‘Š.xlsx");
    }

    // --- Tab 2 Functions ---
    function syncFactoryLock() {
        const isLocked = document.getElementById('F-PriorityLock').checked;
        const cRateInput = document.getElementById('F-CustRate');
        const dSubInput = document.getElementById('F-SubDealer');
        const mChargeInput = document.getElementById('M-ChargeRate');
        const mCustInput = document.getElementById('M-CustRate');
        const fChargeVal = document.getElementById('F-ChargeRate').value;

        if(isLocked) {
            cRateInput.disabled = false; cRateInput.style.background = "#fff";
            dSubInput.disabled = true; dSubInput.value = ""; dSubInput.placeholder = "é–å®šæ¨¡å¼ä¸è¼¸å…¥"; dSubInput.style.background = "#e2e8f0";
            mCustInput.disabled = false; mCustInput.style.background = "#fff";
            if(!mChargeInput.value) mChargeInput.value = fChargeVal;
            if(!mCustInput.value) mCustInput.value = fChargeVal;
        } else {
            cRateInput.disabled = true; cRateInput.style.background = "#e2e8f0"; cRateInput.value = fChargeVal;
            dSubInput.disabled = false; dSubInput.placeholder = "è¼¸å…¥é‡‘é¡ (0=æ¶ˆD)"; dSubInput.style.background = "#fff";
            mCustInput.disabled = true; mCustInput.style.background = "#e2e8f0"; mCustInput.value = mChargeInput.value || fChargeVal;
            if(!mChargeInput.value) mChargeInput.value = fChargeVal;
        }
    }

    function exportToExcel() {
        // 1. ç²å–è¨­å®šåƒæ•¸
        const start = parseInt(document.getElementById('R-Start').value) * 10000;
        const end = parseInt(document.getElementById('R-End').value) * 10000;
        const step = parseInt(document.getElementById('R-Step').value) * 10000;
        const terms = Array.from(document.querySelectorAll('.term-selector input:checked')).map(c => parseInt(c.value));

        if (terms.length === 0) return alert("è«‹é¸æ“‡æœŸæ•¸");

        // 2. æº–å‚™ Excel æ•¸æ“šçµæ§‹ (Array of Arrays)
        let data = [];
        let headerRow = ["åˆ†æœŸé‡‘é¡"]; // ç¬¬ä¸€åˆ—ï¼šå¤§æ¨™é¡Œ (æœŸæ•¸)
        let subHeaderRow = [""];     // ç¬¬äºŒåˆ—ï¼šå­æ¨™é¡Œ (æœˆä»˜/åˆ©ç‡/è£œè²¼)
        let merges = [{ s: { r: 0, c: 0 }, e: { r: 1, c: 0 } }]; // åˆä½µA1:A2 (åˆ†æœŸé‡‘é¡)

        let colIndex = 1; // å¾ç¬¬2æ¬„é–‹å§‹ (Index 1)

        // å»ºæ§‹è¡¨é ­
        terms.forEach(t => {
            headerRow.push(`${t} æœŸ`, null, null); // æ¨™é¡Œä½”ä½
            // è¨­å®šåˆä½µï¼šå¾ (Row 0, Col Index) åˆ° (Row 0, Col Index+2) -> è·¨3æ¬„
            merges.push({ s: { r: 0, c: colIndex }, e: { r: 0, c: colIndex + 2 } });
            
            subHeaderRow.push("æœˆä»˜æ¬¾", "å®¢æˆ¶åˆ©ç‡(%)", "ç¶“éŠ·è£œè²¼/é€€ä½£");
            colIndex += 3;
        });

        data.push(headerRow);
        data.push(subHeaderRow);

        // 3. è¿´åœˆè¨ˆç®—æ¯ä¸€ç­†æ•¸æ“š
        const agentMax = parseFloat(document.getElementById('F-SubAgent').value) || 0;

        for (let amt = start; amt <= end; amt += step) {
            let row = [amt]; // ç¬¬ä¸€æ¬„æ”¾é‡‘é¡

            terms.forEach(t => {
                // å‘¼å«å·¥å» è¨ˆç®—é‚è¼¯å–å¾—æœˆä»˜æ¬¾
                let cellData = calcFactoryCell(amt, t, null, null, null);
                let pmt = cellData.pmt;
                let chargeM = cellData.chargeRateM;

                // é‡æ–°è¨ˆç®—è¡ç”Ÿæ•¸æ“š (åˆ©ç‡ & è£œè²¼)
                let flows = new Array(t).fill(pmt);
                let irr = solveIRR(-amt, flows);
                if (irr < 0) irr = 0;
                let rate = parseFloat((irr * 1200).toFixed(2)); // è½‰ç‚ºæ•¸å­—æ ¼å¼ 3.5

                // è¨ˆç®—è£œè²¼/é€€ä½£
                let totalS = calculateActualS(amt, chargeM, flows);
                let dealerResult = 0;

                if (totalS > 0) {
                    // æ­£å€¼ï¼šé€€ä½£ (Profit)
                    dealerResult = totalS;
                } else {
                    // è² å€¼ï¼šéœ€è¦è£œè²¼ (Cost)
                    let subNeeded = Math.abs(totalS);
                    let agentUsed = Math.min(subNeeded, agentMax);
                    let dealerUsed = subNeeded - agentUsed;
                    dealerResult = -dealerUsed; // è½‰ç‚ºè² æ•¸è¡¨ç¤ºæ”¯å‡º
                }

                row.push(pmt, rate, dealerResult);
            });
            data.push(row);
        }

        // 4. ç”¢ç”Ÿ Worksheet
        var ws = XLSX.utils.aoa_to_sheet(data);

        // 5. å¥—ç”¨åˆä½µå„²å­˜æ ¼è¨­å®š
        ws['!merges'] = merges;

        // 6. å»ºç«‹ Workbook ä¸¦åŒ¯å‡º
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "è‘µèŠ±å¯¶å…¸_åˆ†æ¬„ç‰ˆ");
        
        // ä¿ç•™åŸæœ¬çš„æ‰‹å‹•è©¦ç®—æ¸…å–® (è‹¥æœ‰çš„è©±)
        var manualTable = document.querySelector('.result-list-table');
        if(manualTable && manualTable.rows.length > 1) {
             var ws_manual = XLSX.utils.table_to_sheet(manualTable);
             XLSX.utils.book_append_sheet(wb, ws_manual, "æ‰‹å‹•è©¦ç®—æ¸…å–®");
        }

        XLSX.writeFile(wb, 'BSD_è‘µèŠ±å¯¶å…¸_ç²¾ç´°ç‰ˆ.xlsx');
    }

    function generateMatrix() {
        const start = parseInt(document.getElementById('R-Start').value) * 10000;
        const end = parseInt(document.getElementById('R-End').value) * 10000;
        const step = parseInt(document.getElementById('R-Step').value) * 10000;
        const terms = Array.from(document.querySelectorAll('.term-selector input:checked')).map(c=>parseInt(c.value));
        if(terms.length===0) return alert("è«‹é¸æ“‡æœŸæ•¸");
        const thead = document.querySelector('#sf-matrix thead tr');
        thead.innerHTML = '<th class="row-header">åˆ†æœŸé‡‘é¡</th>';
        terms.forEach(t => thead.innerHTML += `<th>${t} æœŸ</th>`);
        const tbody = document.querySelector('#sf-matrix tbody');
        tbody.innerHTML = '';
        for(let amt=start; amt<=end; amt+=step) {
            let tr = document.createElement('tr');
            tr.innerHTML = `<td class="row-header">${amt/10000} è¬</td>`;
            terms.forEach(t => {
                let cellData = calcFactoryCell(amt, t, null, null, null);
                let td = document.createElement('td');
                td.innerHTML = renderCellHTML(amt, t, cellData.pmt, null, null);
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        }
    }

    function calcFactoryCell(loan, term, overridePmt = null, manualCharge = null, manualCust = null) {
        const globalCharge = parseFloat(document.getElementById('F-ChargeRate').value);
        const globalCust = parseFloat(document.getElementById('F-CustRate').value);
        const chargeRateVal = (manualCharge !== null) ? manualCharge : globalCharge;
        const chargeRateM = chargeRateVal/100/12;
        const lockMode = document.getElementById('F-PriorityLock').checked;
        let targetRateVal = (manualCust !== null) ? manualCust : globalCust;
        if (!lockMode) targetRateVal = chargeRateVal;
        let targetRateM = targetRateVal/100/12;
        const agentMax = parseFloat(document.getElementById('F-SubAgent').value)||0;
        let dealerInput = document.getElementById('F-SubDealer').value;
        let dealerFixed = parseFloat(dealerInput) || 0;

        let pmt = 0;
        if (overridePmt !== null) {
            pmt = overridePmt;
        } else {
            if (lockMode) {
                let pow = Math.pow(1+targetRateM, term);
                pmt = Math.ceil(loan * targetRateM * pow / (pow - 1));
            } else {
                let netLoan = loan - (agentMax + dealerFixed);
                let pow = Math.pow(1+chargeRateM, term);
                pmt = Math.ceil(netLoan * chargeRateM * pow / (pow - 1));
                
                let limit = -(agentMax + dealerFixed);
                const getS = (p) => {
                    let flows = new Array(term).fill(p);
                    return calculateActualS(loan, chargeRateM, flows);
                };
                while (getS(pmt) < limit) {
                    pmt++;
                }
            }
            let minPmt = Math.ceil(loan / term);
            if(pmt < minPmt) pmt = minPmt;
        }
        return { pmt, chargeRateM };
    }

    function renderCellHTML(loan, term, pmt, manualCharge=null, manualCust=null) {
        const globalCharge = parseFloat(document.getElementById('F-ChargeRate').value);
        const chargeRateVal = (manualCharge !== null) ? manualCharge : globalCharge;
        const chargeM = chargeRateVal/100/12;
        const agentMax = parseFloat(document.getElementById('F-SubAgent').value)||0;
        
        let flows = new Array(term).fill(pmt);
        let irr = solveIRR(-loan, flows);
        if(irr < 0) irr = 0;
        let rate = (irr*1200).toFixed(2);
        
        let totalS = calculateActualS(loan, chargeM, flows); 
        let subNeeded = (totalS < 0) ? Math.abs(totalS) : 0;
        let commission = (totalS > 0) ? totalS : 0;
        
        let agentUsed = Math.min(subNeeded, agentMax);
        let dealerUsed = subNeeded - agentUsed;
        
        let unusedAgent = agentMax - agentUsed;
        let showAgentActual = (agentMax > 0 && unusedAgent > 1000);

        let subStr = "";
        if (commission > 0) {
            subStr = `<span class="res-sub" style="color:green">ç”¢ç”Ÿé€€åˆ©ç‡ä½£ï¼š$${commission.toLocaleString()}</span>`;
        } else {
            let parts = [];
            if(dealerUsed > 0) {
                parts.push(`<span style="color:red">ç¶“éŠ·å•†è£œè²¼ï¼š$${dealerUsed.toLocaleString()}</span>`);
            }
            if(showAgentActual) {
                parts.push(`<span style="color:var(--agent-color)">ç¸½ä»£ç†è£œè²¼å¯¦éš›ä½¿ç”¨ï¼š$${agentUsed.toLocaleString()}</span>`);
            }
            subStr = parts.length > 0 ? `<span class="res-sub">${parts.join('<br>')}</span>` : `<span class="res-sub" style="height:14px; display:block;"></span>`;
        }

        return `<div class="res-cell"><span class="res-pmt" style="font-size:15px; color:#001e50;">$${pmt.toLocaleString()}</span><span class="res-rate">${rate}%</span>${subStr}<button class="btn btn-rev" onclick="reviseMatrixCell(this, ${loan}, ${term}, ${manualCharge}, ${manualCust})">æ ¡è¨‚</button></div>`;
    }

    function reviseMatrixCell(btn, loan, term, mCharge, mCust) {
        let parent = btn.parentElement;
        let pmtText = parent.querySelector('.res-pmt').innerText.replace('$','').replace(/,/g,'');
        let mc = mCharge === null ? 'null' : mCharge;
        let mu = mCust === null ? 'null' : mCust;
        parent.innerHTML = `<input type="number" value="${pmtText}" style="width:80px; text-align:center; border:2px solid var(--warning); border-radius:4px;" onblur="saveMatrixRevise(this, ${loan}, ${term}, ${mc}, ${mu})" onkeydown="if(event.key==='Enter') this.blur()"><span style="font-size:10px; color:gray">è¼¸å…¥å¾Œé›¢é–‹</span>`;
        parent.querySelector('input').focus();
    }

    function saveMatrixRevise(input, loan, term, mCharge, mCust) {
        let newPmt = parseInt(input.value);
        if(!newPmt) return;
        let td = input.parentElement.parentElement;
        let realMC = (mCharge === 'null' || isNaN(mCharge)) ? null : mCharge;
        let realMU = (mCust === 'null' || isNaN(mCust)) ? null : mCust;
        td.innerHTML = renderCellHTML(loan, term, newPmt, realMC, realMU);
    }

    function addManualResultRow() {
        const loan = parseFloat(document.getElementById('M-Amt').value);
        if(!loan) return alert("è«‹è¼¸å…¥åˆ†æœŸé‡‘é¡");
        const mCharge = parseFloat(document.getElementById('M-ChargeRate').value);
        const mCust = parseFloat(document.getElementById('M-CustRate').value);
        if(isNaN(mCharge) || isNaN(mCust)) return alert("è«‹ç¢ºèªåˆ©ç‡æ¬„ä½");

        let phases = [];
        let pBoxes = document.querySelectorAll('.manual-input-area .phase-box');
        pBoxes.forEach(box => {
            let inputs = box.querySelectorAll('input');
            let m = parseInt(inputs[0].value)||0;
            let v = inputs[1].value === "" ? null : parseFloat(inputs[1].value);
            if(m>0) phases.push({ m, v, isAuto: (v===null) });
        });
        if(phases.length===0) return alert("è«‹è¼¸å…¥è‡³å°‘ä¸€çµ„æœŸæ•¸");
        
        let res = calcManualPhases(loan, phases, null, mCharge, mCust);
        const tbody = document.getElementById('manual-results-body');
        const rowId = 'mr-' + Date.now();
        let tr = document.createElement('tr');
        tr.id = rowId;
        tr.innerHTML = renderManualRowHTML(loan, res, phases, rowId, mCharge, mCust);
        tbody.appendChild(tr);
        document.getElementById('M-Amt').value = '';
        pBoxes.forEach(box => box.querySelectorAll('input').forEach(i => i.value=''));
    }

    function calcManualPhases(loan, phases, overridePmt, mCharge, mCust) {
        const chargeRateVal = mCharge;
        const chargeRateM = chargeRateVal/100/12;
        const lockMode = document.getElementById('F-PriorityLock').checked;
        const agentMax = parseFloat(document.getElementById('F-SubAgent').value)||0;
        let dealerInput = document.getElementById('F-SubDealer').value;
        let dealerFixed = parseFloat(dealerInput) || 0;

        let calcPmt = 0;
        if(overridePmt !== null) {
            calcPmt = overridePmt;
        } else {
            let targetPV = 0;
            let targetRate = 0;
            if(lockMode) { targetRate = mCust/100/12; targetPV = loan; } 
            else { targetRate = chargeRateM; targetPV = loan - (agentMax + dealerFixed); }
            let fixedPV = 0, varFactor = 0, t = 0;
            phases.forEach(p => {
                for(let k=0; k<p.m; k++) {
                    t++;
                    let disc = 1/Math.pow(1+targetRate, t);
                    if(!p.isAuto) fixedPV += p.v * disc;
                    else varFactor += disc;
                }
            });
            if(varFactor > 0) calcPmt = Math.ceil((targetPV - fixedPV)/varFactor);

            if (!lockMode) {
                let limit = -(agentMax + dealerFixed);
                const getS_Multi = (p) => {
                    let t_s = 0, npv_u = 0;
                    phases.forEach(ph => {
                        let val = ph.isAuto ? p : ph.v;
                        for(let k=0; k<ph.m; k++) {
                            t_s++;
                            npv_u += (val / loan * 10000) / Math.pow(1 + chargeRateM, t_s);
                        }
                    });
                    return Math.round(Math.floor(npv_u - 10000) * loan / 10000);
                };
                while (getS_Multi(calcPmt) < limit) { calcPmt++; }
            }
            
            // 0% Floor Logic
            let flowsCheck = [];
            phases.forEach(ph=>{ for(let k=0; k<ph.m; k++) flowsCheck.push(ph.isAuto?calcPmt:ph.v); });
            while(solveIRR(-loan, flowsCheck) < 0) {
                calcPmt++;
                flowsCheck = [];
                phases.forEach(ph=>{ for(let k=0; k<ph.m; k++) flowsCheck.push(ph.isAuto?calcPmt:ph.v); });
            }
        }

        let flows = [], details = [], st = 1;
        phases.forEach(p => {
            let val = p.isAuto ? calcPmt : p.v;
            for(let k=0; k<p.m; k++) flows.push(val);
            let end = st + p.m - 1;
            details.push(`<span class="detail-item">${st}-${end}æœŸ: $${val.toLocaleString()}</span>`);
            st += p.m;
        });

        let irr = solveIRR(-loan, flows);
        if(irr<0) irr=0;
        let rate = (irr*1200).toFixed(2);
        let totalS = calculateActualS(loan, chargeRateM, flows);
        let subNeeded = (totalS < 0) ? Math.abs(totalS) : 0;
        let commission = (totalS > 0) ? totalS : 0;
        let agentUsed = Math.min(subNeeded, agentMax);
        let dealerUsed = subNeeded - agentUsed;

        return { rate, dealerUsed, agentUsed, commission, details, flows, autoPmt: calcPmt };
    }

    function renderManualRowHTML(loan, res, phases, rowId, mCharge, mCust) {
        let phasesJson = JSON.stringify(phases).replace(/"/g, '&quot;');
        const agentMax = parseFloat(document.getElementById('F-SubAgent').value)||0;
        let unusedAgent = agentMax - res.agentUsed;
        let showAgentActual = (agentMax > 0 && unusedAgent > 1000);

        let subStr = "";
        if (res.commission > 0) {
            subStr = `<span style="color:green; font-weight:bold;">ç”¢ç”Ÿé€€åˆ©ç‡ä½£ï¼š$${res.commission.toLocaleString()}</span>`;
        } else {
            let parts = [];
            if(res.dealerUsed > 0) parts.push(`<div style="color:red; font-weight:bold;">ç¶“éŠ·å•†è£œè²¼ï¼š$${res.dealerUsed.toLocaleString()}</div>`);
            if(showAgentActual) parts.push(`<div style="color:var(--agent-color); font-weight:bold;">ç¸½ä»£ç†è£œè²¼å¯¦éš›ä½¿ç”¨ï¼š$${res.agentUsed.toLocaleString()}</div>`);
            subStr = parts.join('');
        }
        
        return `<td>${loan.toLocaleString()}</td>
                <td><div class="detail-row">${res.details.join('')}</div></td>
                <td><b>${res.rate}%</b></td>
                <td>${subStr}</td>
                <td><button class="btn btn-rev" onclick="reviseManualRow('${rowId}', ${loan}, ${mCharge}, ${mCust})">æ ¡è¨‚</button> <button class="btn btn-del" onclick="document.getElementById('${rowId}').remove()">åˆªé™¤</button><div id="data-${rowId}" style="display:none;">${phasesJson}</div></td>`;
    }

    function reviseManualRow(rowId, loan, mCharge, mCust) {
        let phases = JSON.parse(document.getElementById('data-'+rowId).innerText);
        if(!phases.some(p=>p.isAuto)) return alert("æ­¤çµ„åˆæ²’æœ‰è‡ªå‹•è¨ˆç®—çš„æ¬„ä½ï¼Œç„¡æ³•æ ¡è¨‚");
        let newPmt = prompt("è«‹è¼¸å…¥ä¿®æ­£å¾Œçš„æœˆä»˜æ¬¾:");
        if(newPmt===null) return;
        newPmt = parseInt(newPmt);
        if(isNaN(newPmt)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");
        let res = calcManualPhases(loan, phases, newPmt, mCharge, mCust);
        document.getElementById(rowId).innerHTML = renderManualRowHTML(loan, res, phases, rowId, mCharge, mCust);
    }

    // --- çœ¼ç›è¶…èˆ’æœæ¨¡å¼ JS (Updated) ---
    const ComfortMode = {
        data: {
            mode: 0, step: 0, msrp: '', amount: '', payType: '', terms: [], chargeRate: '', custRate: '', agentSub: '', dealerSub: '', payments: []
        },
        
        init: function() {
            const isMobile = window.innerWidth <= 1024 || /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
            if (!isMobile) {
                if(!confirm("æ­¤åŠŸèƒ½æ˜¯ç‚ºæ‰‹æ©Ÿ/å¹³æ¿è¨­è¨ˆçš„è¶…å¤§å­—é«”æ¨¡å¼ï¼Œåœ¨é›»è…¦ä¸Šä½¿ç”¨æœƒä½”æ»¿è¢å¹•ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return;
            }
            document.getElementById('comfort-overlay').style.display = 'flex';
            this.resetData();
            this.renderStep0();
        },

        resetData: function() {
            this.data = { mode: 0, step: 0, msrp: '', amount: '', payType: '', terms: [], chargeRate: '', custRate: '', agentSub: '', dealerSub: '', payments: [] };
            document.getElementById('comfort-stepper').innerHTML = ''; // Clean stepper
        },

        exit: function() {
            if(confirm("ç¢ºå®šè¦é›¢é–‹èˆ’é©æ¨¡å¼å—ï¼Ÿ")) {
                document.getElementById('comfort-overlay').style.display = 'none';
            }
        },

        // --- Stepper Rendering Logic ---
        updateStepper: function(stepIdx) {
            const container = document.getElementById('comfort-stepper');
            
            // Map step index to data values for display
            // Data mapping logic:
            const d = this.data;
            const stepsMap = [];
            
            stepsMap.push({idx:0, label:'æ¨¡å¼', val: this.getModeLabel(d.mode)});
            stepsMap.push({idx:1, label:'å»ºè­°å”®åƒ¹', val: d.msrp ? (parseInt(d.msrp)/10000 + 'è¬') : ''});
            stepsMap.push({idx:2, label:'åˆ†æœŸé‡‘é¡', val: d.amount ? (parseInt(d.amount)/10000 + 'è¬') : ''});
            stepsMap.push({idx:3, label:'ä»˜æ¬¾çµæ§‹', val: d.terms.length ? (d.terms.join('+') + 'æœŸ') : ''});
            stepsMap.push({idx:4, label:'ç‰Œåƒ¹åˆ©ç‡', val: d.chargeRate ? (d.chargeRate + '%') : ''});
            if(d.mode !== 3) stepsMap.push({idx:5, label:'å®¢æˆ¶åˆ©ç‡', val: d.custRate ? (d.custRate + '%') : 'æœªçŸ¥'});
            stepsMap.push({idx:6, label:'ç¸½ä»£è£œè²¼', val: d.agentSub > 0 ? d.agentSub : ''});
            if(d.mode !== 2) stepsMap.push({idx:7, label:'ç¶“éŠ·è£œè²¼', val: d.dealerSub > 0 ? d.dealerSub : ''});
            stepsMap.push({idx:8, label:'æœˆä»˜å…§å®¹', val: d.payments.length ? 'å·²å¡«' : ''});
            stepsMap.push({idx:9, label:'çµæœ', val: ''});

            // Generate HTML
            let html = '';
            stepsMap.forEach((s, i) => {
                let status = '';
                if(s.idx < stepIdx) status = 'done';
                if(s.idx === stepIdx) status = 'active';
                
                html += `
                    <div class="step-item ${status}">
                        <div class="step-circle">${s.idx === 9 ? 'â˜…' : i+1}</div>
                        <div class="step-label">${s.label}</div>
                        <div class="step-data">${s.val}</div>
                    </div>
                    ${i < stepsMap.length - 1 ? `<div class="step-line ${status}"></div>` : ''}
                `;
            });

            container.innerHTML = html;
            // Scroll to active
            setTimeout(() => {
                const active = container.querySelector('.active');
                if(active) active.scrollIntoView({behavior:'smooth', inline:'center'});
            }, 100);
        },
        
        getModeLabel: function(m) {
            if(m===1) return 'æœˆä»˜æ¬¾';
            if(m===2) return 'è£œè²¼';
            if(m===3) return 'å›æ¨';
            return '';
        },

        renderStep0: function() {
            this.data.step = 0;
            this.updateStepper(0);
            const html = `
                <div class="c-title">è«‹å•æ‚¨ä»Šå¤©è¦ç®—ä»€éº¼ï¼Ÿ</div>
                <div class="c-btn-group" style="flex-direction: column;">
                    <button class="c-btn-option" onclick="ComfortMode.setMode(1)">ğŸ’° æˆ‘è¦ç®—æœˆä»˜æ¬¾</button>
                    <button class="c-btn-option" onclick="ComfortMode.setMode(2)">ğŸ¢ æˆ‘è¦ç®—ç¶“éŠ·å•†è£œè²¼æ¯/é€€åˆ©ç‡ä½£</button>
                    <button class="c-btn-option" onclick="ComfortMode.setMode(3)">ğŸ”„ æˆ‘è¦å›æ¨å®¢æˆ¶åˆ©ç‡</button>
                </div>
            `;
            document.getElementById('comfort-question-area').innerHTML = html;
        },

        setMode: function(mode) {
            this.data.mode = mode;
            this.nextStep();
        },

        nextStep: function() {
            this.data.step++;
            this.renderRouter(this.data.step);
        },

        prevStep: function() {
            if(this.data.step <= 0) return;
            this.data.step--;
            if(this.data.step === 0) this.renderStep0();
            else this.renderRouter(this.data.step);
        },

        renderRouter: function(step) {
            this.updateStepper(step);
            const d = this.data;
            switch(step) {
                case 1: this.renderMSRP(); break;
                case 2: this.renderAmount(); break;
                case 3: this.renderPayType(); break;
                case 4: this.renderChargeRate(); break;
                case 5: 
                    if(d.mode === 3) this.nextStep(); 
                    else this.renderCustRate(); 
                    break;
                case 6: this.renderAgentSub(); break;
                case 7: 
                    if(d.mode === 2) this.nextStep();
                    else this.renderDealerSub();
                    break;
                case 8: this.renderPayments(); break;
                case 9: this.renderDashboard(); break;
            }
        },

        renderMSRP: function() {
            const html = `
                <div class="c-title">å»ºè­°å”®åƒ¹</div>
                <div class="c-subtitle">éå¿…å¡«ï¼Œåƒ…ä¾›åƒè€ƒ</div>
                <input type="number" id="inp-msrp" class="c-input" placeholder="è«‹è¼¸å…¥é‡‘é¡" value="${this.data.msrp}" onkeydown="if(event.key==='Enter') ComfortMode.saveMSRP()">
                <button class="c-btn-submit" onclick="ComfortMode.saveMSRP()">é€å‡º / ç•¥é</button>
            `;
            this.renderHTML(html, 'inp-msrp');
        },
        saveMSRP: function() {
            this.data.msrp = document.getElementById('inp-msrp').value;
            this.nextStep();
        },

        renderAmount: function() {
            const html = `
                <div class="c-title">åˆ†æœŸé‡‘é¡</div>
                <input type="number" id="inp-amt" class="c-input" placeholder="ä¾‹å¦‚: 1000000" value="${this.data.amount}" onkeydown="if(event.key==='Enter') ComfortMode.saveAmount()">
                <button class="c-btn-submit" onclick="ComfortMode.saveAmount()">é€å‡º</button>
            `;
            this.renderHTML(html, 'inp-amt');
        },
        saveAmount: function() {
            const val = document.getElementById('inp-amt').value;
            if(!val || val <= 0) return this.showError("é‡‘é¡å¿…é ˆå¤§æ–¼0");
            this.data.amount = val;
            this.nextStep();
        },

        renderPayType: function() {
            const html = `
                <div class="c-title">ä»˜æ¬¾æ–¹å¼</div>
                <div class="c-btn-group" style="margin-bottom:20px;">
                    <button class="c-btn-option" id="btn-type-c" onclick="ComfortMode.selectType('classic')">å‡æ”¤ (Classic)</button>
                    <button class="c-btn-option" id="btn-type-b" onclick="ComfortMode.selectType('balloon')">å°¾æ¬¾ (Balloon)</button>
                    <button class="c-btn-option" id="btn-type-s" onclick="ComfortMode.selectType('step')">éšæ®µ (Step)</button>
                </div>
                <div id="terms-container"></div>
                <button class="c-btn-submit" onclick="ComfortMode.saveTerms()">é€å‡º</button>
            `;
            this.renderHTML(html);
            if(this.data.payType) this.selectType(this.data.payType);
        },
        selectType: function(type) {
            this.data.payType = type;
            ['c','b','s'].forEach(k => {
                const el = document.getElementById(`btn-type-${k}`);
                if(el) el.classList.remove('selected');
            });
            document.getElementById(`btn-type-${type[0]}`).classList.add('selected');
            
            let inputs = '';
            if(type === 'classic') inputs = `<input type="number" class="c-input term-input" placeholder="æœŸæ•¸ (ä¾‹å¦‚ 60)" value="60">`;
            if(type === 'balloon') inputs = `<input type="number" class="c-input term-input" placeholder="æœŸæ•¸" style="margin-bottom:10px;"><input type="number" class="c-input term-input" placeholder="å°¾æ¬¾æœŸæ•¸ (é€šå¸¸ç‚º1)" value="1">`;
            if(type === 'step') {
                for(let i=0; i<5; i++) inputs += `<input type="number" class="c-input term-input" placeholder="ç¬¬${i+1}æ®µæœŸæ•¸" style="width:45%; margin:2%;">`;
            }
            document.getElementById('terms-container').innerHTML = inputs;
        },
        saveTerms: function() {
            if(!this.data.payType) return this.showError("è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼");
            const inputs = document.querySelectorAll('.term-input');
            let terms = [];
            inputs.forEach(inp => { if(inp.value && inp.value > 0) terms.push(inp.value) });
            if(terms.length === 0) return this.showError("è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æœŸæ•¸");
            this.data.terms = terms;
            this.nextStep();
        },

        renderChargeRate: function() {
            const html = `
                <div class="c-title">ç‰Œåƒ¹åˆ©ç‡ (%)</div>
                <input type="number" id="inp-charge" class="c-input" inputmode="decimal" placeholder="ä¾‹å¦‚: 3.5" value="${this.data.chargeRate}" onkeydown="if(event.key==='Enter') ComfortMode.saveCharge()">
                <button class="c-btn-submit" onclick="ComfortMode.saveCharge()">é€å‡º</button>
            `;
            this.renderHTML(html, 'inp-charge');
        },
        saveCharge: function() {
            const val = document.getElementById('inp-charge').value;
            if(!val) return this.showError("è«‹è¼¸å…¥ç‰Œåƒ¹åˆ©ç‡");
            this.data.chargeRate = val;
            this.nextStep(); 
        },

        renderCustRate: function() {
            const isRequired = (this.data.mode === 2);
            let html = `
                <div class="c-title">å®¢æˆ¶åˆ©ç‡ (%)</div>
                <div class="c-subtitle">${isRequired ? '<span style="color:red">è«‹è¼¸å…¥åˆ©ç‡ï¼Œæˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç•¥é</span>' : 'è‹¥æœªå¡«å‰‡ç­‰æ–¼ç‰Œåƒ¹åˆ©ç‡'}</div>
                <input type="number" id="inp-cust" class="c-input" inputmode="decimal" placeholder="ä¾‹å¦‚: 2.99" value="${this.data.custRate}" onkeydown="if(event.key==='Enter') ComfortMode.saveCust()">
                <button class="c-btn-submit" onclick="ComfortMode.saveCust()">é€å‡º</button>
                ${isRequired ? `<button class="c-btn c-btn-secondary" style="margin-top:10px; width:80%;" onclick="ComfortMode.skipCust()">ç•¥é (ç”±æœˆä»˜æ¬¾åæ¨)</button>` : ''}
            `;
            this.renderHTML(html, 'inp-cust');
        },
        saveCust: function() {
            let val = document.getElementById('inp-cust').value;
            if(this.data.mode === 2 && !val) return this.showError("è«‹è¼¸å…¥åˆ©ç‡æˆ–é»æ“Šç•¥é");
            if(!val && this.data.mode === 1) val = this.data.chargeRate; 
            this.data.custRate = val;
            this.nextStep();
        },
        skipCust: function() {
            this.data.custRate = ''; // Explicitly null for calc mode
            this.nextStep();
        },

        renderAgentSub: function() {
            const html = `
                <div class="c-title">ç¸½ä»£ç†è£œè²¼æ¬¾</div>
                <div class="c-subtitle">è‹¥ç„¡è«‹å¡« 0</div>
                <input type="number" id="inp-asub" class="c-input" placeholder="é‡‘é¡" value="${this.data.agentSub}" onkeydown="if(event.key==='Enter') ComfortMode.saveAgentSub()">
                <button class="c-btn-submit" onclick="ComfortMode.saveAgentSub()">é€å‡º</button>
            `;
            this.renderHTML(html, 'inp-asub');
        },
        saveAgentSub: function() {
            const val = document.getElementById('inp-asub').value || 0;
            this.data.agentSub = val;
            this.nextStep();
        },

        renderDealerSub: function() {
            const html = `
                <div class="c-title">ç¶“éŠ·å•†è£œè²¼æ¬¾</div>
                <div class="c-subtitle">è‹¥ç„¡è«‹å¡« 0</div>
                <input type="number" id="inp-dsub" class="c-input" placeholder="é‡‘é¡" value="${this.data.dealerSub}" onkeydown="if(event.key==='Enter') ComfortMode.saveDealerSub()">
                <button class="c-btn-submit" onclick="ComfortMode.saveDealerSub()">é€å‡º</button>
            `;
            this.renderHTML(html, 'inp-dsub');
        },
        saveDealerSub: function() {
            const val = document.getElementById('inp-dsub').value || 0;
            this.data.dealerSub = val;
            this.nextStep();
        },

        renderPayments: function() {
            let inputsHTML = '';
            const count = this.data.terms.length;
            const mode = this.data.mode;
            const hasCustRate = (this.data.custRate !== '');
            
            // Logic guide string
            let guide = "";
            if (mode === 2) { // Subsidy Mode
                if(hasCustRate) guide = "æ‚¨å·²é–å®šå®¢æˆ¶åˆ©ç‡ï¼Œè«‹<span style='color:red'>ä¿ç•™ä¸€å€‹æ¬„ä½ç©ºç™½</span>è®“ç³»çµ±è¨ˆç®—æœˆä»˜æ¬¾ã€‚";
                else guide = "æ‚¨é¸æ“‡ç”±æœˆä»˜æ¬¾åæ¨ï¼Œè«‹<span style='color:red'>å¡«å¯«æ‰€æœ‰æ¬„ä½</span>ã€‚";
            } else if (mode === 3) {
                guide = "è¨ˆç®—åˆ©ç‡æ¨¡å¼ï¼Œè«‹<span style='color:red'>å¡«å¯«æ‰€æœ‰æ¬„ä½</span>ã€‚";
            } else {
                guide = "è‹¥ç‚ºå‡æ”¤å¯å…¨ç©ºï¼Œè‹¥æœ‰å°¾æ¬¾è«‹å¡«å¯«å·²çŸ¥éƒ¨åˆ†ã€‚";
            }

            for(let i=0; i<count; i++) {
                inputsHTML += `
                    <div style="text-align:left; width:80%; margin-top:10px;">ç¬¬ ${i+1} ç­†æœˆä»˜æ¬¾ (${this.data.terms[i]}æœŸ):</div>
                    <input type="number" class="c-input pay-input" data-idx="${i}" placeholder="è¼¸å…¥é‡‘é¡" style="margin-bottom:5px;">
                `;
            }

            const html = `
                <div class="c-title">æœˆä»˜æ¬¾è¨­å®š</div>
                <div class="c-subtitle">${guide}</div>
                <div style="max-height: 40vh; overflow-y:auto; width:100%; display:flex; flex-direction:column; align-items:center;">
                    ${inputsHTML}
                </div>
                <button class="c-btn-submit" onclick="ComfortMode.savePayments()">é€å‡ºä¸¦è¨ˆç®—</button>
            `;
            this.renderHTML(html);
        },
        savePayments: function() {
            const inputs = document.querySelectorAll('.pay-input');
            let pays = [];
            let emptyCount = 0;
            inputs.forEach(inp => {
                pays.push(inp.value);
                if(!inp.value) emptyCount++;
            });

            // Validation Logic
            const mode = this.data.mode;
            const hasCustRate = (this.data.custRate !== '');

            if (mode === 2) {
                if (hasCustRate) {
                    // Path B: Must have at least 1 empty to calc
                    if(emptyCount === 0) return this.showError("æ—¢é–å®šåˆ©ç‡åˆå¡«æ»¿æœˆä»˜æ¬¾ï¼Œç³»çµ±ç„¡æ³•è¨ˆç®—ã€‚è«‹æ¸…ç©ºä¸€æ¬„ã€‚");
                } else {
                    // Path A: Must fill all
                    if(emptyCount > 0) return this.showError("åæ¨æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰æœˆä»˜æ¬¾éƒ½å¿…é ˆè¼¸å…¥ï¼");
                }
            }
            if (mode === 3) {
                if(emptyCount > 0) return this.showError("å›æ¨åˆ©ç‡æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰æœˆä»˜æ¬¾éƒ½å¿…é ˆè¼¸å…¥ï¼");
            }

            this.data.payments = pays;
            
            this.syncToOriginalCore(false); 
            smartSolve(); 
            this.nextStep();
        },

        toggleSubsidyDisplay: function() {
            const isChecked = document.getElementById('show-dealer-sub').checked;
            const subRow = document.getElementById('dash-sub-row');
            if(subRow) {
                subRow.style.display = isChecked ? 'block' : 'none';
            }
        },

        renderDashboard: function() {
            const d = this.data;
            const resValText = document.getElementById('res-val').innerText;
            const resValColor = document.getElementById('res-val').style.color;
            const resTotal = document.getElementById('d-total-pmt').innerText;
            const resIRR_raw = document.getElementById('d-crate').innerText; 
            
            // Format IRR (Floor to 2 decimals)
            let displayIRR = resIRR_raw;
            if(resIRR_raw.includes('%')) {
                let num = parseFloat(resIRR_raw.replace('%',''));
                if(!isNaN(num)) {
                    displayIRR = (Math.floor(num * 100) / 100) + '%';
                }
            }
            
            const fullSummary = document.getElementById('d-summary').innerHTML;
            
            let heroLabel = "æœˆä»˜æ¬¾ / å®Œæ•´çµæ§‹";
            let heroValue = fullSummary;
            
            // Dynamic Label Logic based on COLOR
            let dynamicLabel = "ç¶“éŠ·å•†è£œè²¼";
            // Core Logic: Red = Cost (Subsidy), Green = Profit (Commission)
            // Color can be hex or rgb depending on browser
            if (resValColor === 'rgb(22, 163, 74)' || resValColor === '#16a34a') {
                dynamicLabel = "é€€åˆ©ç‡ä½£";
            }

            if(d.mode === 2) { 
                heroLabel = dynamicLabel;
                heroValue = resValText; 
            } else if(d.mode === 3) { 
                heroLabel = "å®¢æˆ¶å¯¦éš›åˆ©ç‡ (IRR)";
                heroValue = displayIRR;
            }

            const html = `
                <div class="dash-card-pro">
                    <div class="pro-header">
                        <div class="pro-title">è©¦ç®—çµæœå ±å‘Š</div>
                        <div class="pro-tag">BSD Core Verified</div>
                    </div>

                    <div class="pro-hero">
                        <div class="pro-hero-label">${heroLabel}</div>
                        <div class="pro-hero-val" style="${d.mode === 2 ? `color:${resValColor}` : ''}">${heroValue}</div>
                        
                        <div id="dash-sub-row" style="display:none; margin-top:15px; border-top:1px dashed rgba(255,255,255,0.3); padding-top:10px;">
                            <div class="pro-hero-label">${dynamicLabel} (æ ¸å¿ƒé‹ç®—)</div>
                            <div class="pro-val" style="font-size:1.5rem; ${`color:${resValColor}`}">${resValText}</div>
                        </div>
                    </div>
                    
                    <div class="pro-grid">
                        <div class="pro-item"><div class="pro-label">åˆ†æœŸé‡‘é¡</div><div class="pro-val">$${parseInt(d.amount).toLocaleString()}</div></div>
                        <div class="pro-item"><div class="pro-label">å»ºè­°å”®åƒ¹</div><div class="pro-val">$${d.msrp ? parseInt(d.msrp).toLocaleString() : '-'}</div></div>
                        <div class="pro-item wide"><div class="pro-label">å®Œæ•´æœˆä»˜æ¬¾çµæ§‹</div><div class="pro-val" style="font-size:1rem; line-height:1.4;">${fullSummary}</div></div>
                        
                        <div class="pro-item"><div class="pro-label">æœŸæ•¸çµæ§‹</div><div class="pro-val">${d.terms.join('+')} æœŸ</div></div>
                        <div class="pro-item"><div class="pro-label">ä»˜æ¬¾æ–¹å¼</div><div class="pro-val" style="text-transform:capitalize">${d.payType}</div></div>
                        <div class="pro-item"><div class="pro-label">ç¸½ä»˜æ¬¾</div><div class="pro-val">${resTotal}</div></div>
                        <div class="pro-item"><div class="pro-label">å®¢æˆ¶åˆ©ç‡</div><div class="pro-val">${displayIRR}</div></div>
                    </div>

                    <div class="pro-footer">
                        æœ¬è©¦ç®—çµæœåƒ…ä¾›åƒè€ƒï¼Œæœ¬å…¬å¸ä¿ç•™æœ€çµ‚å¯©æ ¸åŠè§£é‡‹ä¹‹æ¬Šåˆ©ã€‚<br>è«‹æˆªåœ–ä¿å­˜æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é›¢é–‹ã€‚
                    </div>
                </div>
                
                <div class="toggle-container">
                    <label class="toggle-switch">
                        <input type="checkbox" id="show-dealer-sub" onchange="ComfortMode.toggleSubsidyDisplay()">
                        <span class="slider"></span>
                        é¡¯ç¤ºè£œè²¼/é€€ä½£
                    </label>
                </div>

                <button class="c-btn-submit" style="margin-top:10px;" onclick="ComfortMode.finish()">âœ… å®Œæˆä¸¦é›¢é–‹</button>
                <button class="c-btn-restart" style="margin-top:10px; width:80%;" onclick="ComfortMode.init()">ğŸ”„ é‡æ–°è¨ˆç®—</button>
            `;
            document.getElementById('comfort-question-area').innerHTML = html;
        },

        finish: function() {
            document.getElementById('comfort-overlay').style.display = 'none';
        },

        syncToOriginalCore: function(showAlert = true) {
            const d = this.data;
            document.getElementById('MSRP').value = d.msrp;
            document.getElementById('B20').value = d.amount;
            document.getElementById('B4').value = d.chargeRate;

            const rateLock = document.getElementById('rateLock');
            // Logic Fix: If custRate is explicitly set (Path B), lock it. If empty (Path A), unlock it.
            if(d.custRate !== '' && d.custRate !== null) {
                document.getElementById('CRate').value = d.custRate;
                rateLock.checked = true; 
            } else {
                rateLock.checked = false; 
                document.getElementById('CRate').value = '';
            }

            // CRITICAL LOGIC: Agent Subsidy Security
            // Only allow agent subsidy if user explicitly entered > 0 in comfort mode.
            if (d.agentSub && parseFloat(d.agentSub) > 0) {
                document.getElementById('SubAgent').value = d.agentSub;
                document.getElementById('agentLock').checked = true;
            } else {
                document.getElementById('SubAgent').value = 0; // Force Reset
                document.getElementById('agentLock').checked = false; // Force Unlock
            }

            document.getElementById('SubDealer').value = d.dealerSub;
            document.getElementById('dealerLock').checked = (parseFloat(d.dealerSub) > 0);

            const pMs = document.querySelectorAll('.p-m');
            const pVs = document.querySelectorAll('.p-v');
            
            pMs.forEach(i => i.value = '');
            pVs.forEach(i => i.value = '');

            for(let i=0; i < d.terms.length; i++) {
                if(pMs[i]) pMs[i].value = d.terms[i];
                if(pVs[i] && d.payments[i]) pVs[i].value = d.payments[i];
            }
            updateUI();
            if(showAlert) alert("æ•¸æ“šå·²å¸¶å…¥æ ¸å¿ƒï¼");
        },

        renderHTML: function(html, focusId) {
            document.getElementById('comfort-question-area').innerHTML = html;
            document.getElementById('comfort-error-msg').innerText = '';
            if(focusId && !(/Android|iPhone/i.test(navigator.userAgent))) {
                setTimeout(() => document.getElementById(focusId).focus(), 100);
            }
        },
        showError: function(msg) {
            document.getElementById('comfort-error-msg').innerText = msg;
        }
    };
</script>
</body>
</html>
